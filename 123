local player = game.Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")

-- Xóa GUI cũ
if CoreGui:FindFirstChild("DeltaHub") then
	CoreGui.DeltaHub:Destroy()
end

-- Giao diện chính
local ScreenGui = Instance.new("ScreenGui", CoreGui)
ScreenGui.Name = "DeltaHub"

local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(0, 440, 0, 120)
Frame.Position = UDim2.new(0.5, -220, 0.5, -200)
Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Frame.BorderSizePixel = 0
Frame.Active = true

-- Thanh tiêu đề
local TitleBar = Instance.new("Frame", Frame)
TitleBar.Size = UDim2.new(1, 0, 0, 36)
TitleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 40)

local Title = Instance.new("TextLabel", TitleBar)
Title.Size = UDim2.new(1, -10, 1, 0)
Title.Position = UDim2.new(0, 10, 0, 0)
Title.BackgroundTransparency = 1
Title.Text = "ShopGameTrade"
Title.TextColor3 = Color3.fromRGB(255,255,255)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 14
Title.TextXAlignment = Enum.TextXAlignment.Left

-- Nút tiêu đề
local ButtonHolder = Instance.new("Frame", TitleBar)
ButtonHolder.Size = UDim2.new(0, 250, 1, 0)
ButtonHolder.AnchorPoint = Vector2.new(1, 0)
ButtonHolder.Position = UDim2.new(1, -6, 0, 0)
ButtonHolder.BackgroundTransparency = 1

local function createTopButton(name, color)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(0, 70, 0, 24)
	btn.BackgroundColor3 = color
	btn.Text = name
	btn.TextColor3 = Color3.fromRGB(255,255,255)
	btn.Font = Enum.Font.SourceSansBold
	btn.TextSize = 14
	btn.Parent = ButtonHolder
	return btn
end

local ButtonList = Instance.new("UIListLayout", ButtonHolder)
ButtonList.FillDirection = Enum.FillDirection.Horizontal
ButtonList.Padding = UDim.new(0, 6)
ButtonList.HorizontalAlignment = Enum.HorizontalAlignment.Right
ButtonList.VerticalAlignment = Enum.VerticalAlignment.Center

local CloseBtn = createTopButton("Close", Color3.fromRGB(200,50,50))
local MinBtn = createTopButton("Minimize", Color3.fromRGB(200,180,50))
local MaxBtn = createTopButton("Home", Color3.fromRGB(60,150,255))

-- Di chuyển UI
local dragging = false
local dragStart, startPos
TitleBar.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		dragStart = input.Position
		startPos = Frame.Position
	end
end)
TitleBar.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
		local delta = input.Position - dragStart
		Frame.Position = UDim2.new(
			startPos.X.Scale, startPos.X.Offset + delta.X,
			startPos.Y.Scale, startPos.Y.Offset + delta.Y
		)
	end
end)
UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = false
	end
end)

-- Content chính
local Content = Instance.new("Frame", Frame)
Content.Size = UDim2.new(1, 0, 1, -36)
Content.Position = UDim2.new(0, 0, 0, 36)
Content.BackgroundTransparency = 1

local UIList = Instance.new("UIListLayout", Content)
UIList.Padding = UDim.new(0, 6)
UIList.SortOrder = Enum.SortOrder.LayoutOrder

-- ==========================
-- HÀM TẠO HÀNG NÚT
-- ==========================
local function createRowButtons(buttons)
	local row = Instance.new("Frame", Content)
	row.Size = UDim2.new(1, 0, 0, 40)
	row.BackgroundTransparency = 1
	local num = #buttons
	local spacing = 0.03
	local width = (1 - (spacing * (num - 1))) / num

	for i, info in ipairs(buttons) do
		local btn = Instance.new("TextButton", row)
		btn.Size = UDim2.new(width, 0, 1, 0)
		btn.Position = UDim2.new((i - 1) * (width + spacing), 0, 0, 0)
		btn.BackgroundColor3 = info.color or Color3.fromRGB(150, 100, 50)
		btn.Text = info.name
		btn.TextColor3 = Color3.fromRGB(255,255,255)
		btn.Font = Enum.Font.SourceSansBold
		btn.TextSize = 16
		btn.MouseButton1Click:Connect(info.action)
	end
end

-- ==========================
-- HÀNG: CHEST 1–6
-- ==========================
local lastChest = nil
local minDistance = 50

createRowButtons({
	{name = "Chest 1–4", color = Color3.fromRGB(90,150,255), action = function()
		local nearest, distance = nil, math.huge
		for _, item in ipairs(workspace.Items:GetChildren()) do
			if string.find(item.Name, "Item Chest") then
				local capPart = item:FindFirstChild("ItemDrop", true)
				if capPart and capPart:IsA("BasePart") then
					local dist = (capPart.Position - hrp.Position).Magnitude
					if (not lastChest or (capPart.Position - lastChest.Position).Magnitude > minDistance) and dist < distance then
						nearest, distance = capPart, dist
					end
				end
			end
		end
		if nearest then
			lastChest = nearest
			hrp.CFrame = nearest.CFrame + Vector3.new(0, 5, 0)
			warn("Đến chest mới:", nearest.Name)
		else
			warn("Không tìm thấy chest khác đủ xa")
		end
	end},

	{name = "Chest 5–6", color = Color3.fromRGB(255,150,80), action = function()
		local nearest, distance = nil, math.huge
		for _, item in ipairs(workspace.Items:GetChildren()) do
			if string.find(item.Name, "Item Chest5") or string.find(item.Name, "Item Chest6") then
				local capPart = item:FindFirstChild("ItemDrop", true)
				if capPart and capPart:IsA("BasePart") then
					local dist = (capPart.Position - hrp.Position).Magnitude
					if (not lastChest or (capPart.Position - lastChest.Position).Magnitude > minDistance) and dist < distance then
						nearest, distance = capPart, dist
					end
				end
			end
		end
		if nearest then
			lastChest = nearest
			hrp.CFrame = nearest.CFrame + Vector3.new(0, 5, 0)
			warn("Đến chest mới:", nearest.Name)
		else
			warn("Không tìm thấy chest khác đủ xa")
		end
	end}
})

-- ==========================
-- HÀNG: TEST ĐÁNH OBJECT
-- ==========================
createRowButtons({
	{name = "Đánh Wolf", color = Color3.fromRGB(200,80,80), action = function()
		local target = workspace:FindFirstChild("Characters") and workspace.Characters:FindFirstChild("Wolf")
		if target then
			local args = {
				target,
				player.Inventory:FindFirstChild("Good Axe"),
				"89_7489468770",
				hrp.CFrame
			}
			game.ReplicatedStorage.RemoteEvents.ToolDamageObject:InvokeServer(unpack(args))
			warn("Đánh Wolf thành công")
		else
			warn("Không tìm thấy Wolf")
		end
	end}
})

-- ==========================
-- NÚT ĐÓNG / ẨN
-- ==========================
local tweenInfo = TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
local minimized = false
local savedSize, savedPos = Frame.Size, Frame.Position

local function minimize()
	if minimized then return end
	minimized = true
	savedSize = Frame.Size
	savedPos = Frame.Position
	TweenService:Create(Frame, tweenInfo, {Size = UDim2.new(0, 220, 0, 36)}):Play()
	task.delay(0.22, function() Content.Visible = false end)
end

local function restore()
	if not minimized then return end
	minimized = false
	Content.Visible = true
	TweenService:Create(Frame, tweenInfo, {Size = savedSize, Position = savedPos}):Play()
end

MinBtn.MouseButton1Click:Connect(function()
	if minimized then restore() else minimize() end
end)

MaxBtn.MouseButton1Click:Connect(function()
	hrp.CFrame = hrp.CFrame + Vector3.new(10,10,0)
end)

CloseBtn.MouseButton1Click:Connect(function()
	ScreenGui:Destroy()
end)

UserInputService.InputBegan:Connect(function(input, gp)
	if gp then return end
	if input.KeyCode == Enum.KeyCode.K then
		if minimized then restore() else minimize() end
	end
end)
